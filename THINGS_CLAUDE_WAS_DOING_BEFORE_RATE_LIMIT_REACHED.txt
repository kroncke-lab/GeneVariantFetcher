Plan: CrossRef Fetcher + Supplement Re-fetch Script + Empty Dir Cleanup                                                         │
│                                                                                                                                 │
│ Context                                                                                                                         │
│                                                                                                                                 │
│ 318 of 616 supplement directories are empty — supplements never downloaded. The pipeline has been improved since those papers   │
│ were processed (PMC HTML scraping added, empty dir prevention added, Wiley/Springer/Oxford handlers wired in), but those        │
│ improvements were never retroactively applied. We need:                                                                         │
│ 1. A CrossRef API tier to catch supplements that PMC and Elsevier miss                                                          │
│ 2. A script to re-run the supplement cascade on the 318 failures                                                                │
│ 3. Empty directory cleanup integrated into that script                                                                          │
│                                                                                                                                 │
│ Key finding from exploration: Wiley supplement handler already exists (supplement_scraper.py:709-938) and is already routed via │
│  doi_resolver.py:271-273. No new Wiley code needed.                                                                             │
│                                                                                                                                 │
│ ---                                                                                                                             │
│ Task 1: CrossRef Supplement Fetcher                                                                                             │
│                                                                                                                                 │
│ New file: gene_literature/supplements/crossref_fetcher.py                                                                       │
│                                                                                                                                 │
│ Class: CrossRefSupplementFetcher(SupplementFetcher)                                                                             │
│                                                                                                                                 │
│ Follows the pattern of elsevier_fetcher.py exactly:                                                                             │
│ - Inherits from SupplementFetcher (from base.py)                                                                                │
│ - Uses @api_retry decorator from utils.retry_utils                                                                              │
│ - Returns List[SupplementFile] with source="crossref"                                                                           │
│                                                                                                                                 │
│ Methods:                                                                                                                        │
│ - __init__(timeout=30, email="") — Sets User-Agent with mailto: for CrossRef polite pool (uses NCBI_EMAIL env var). Rate limit  │
│ tracker like UnpaywallClient.                                                                                                   │
│ - fetch(pmid, doi) -> List[SupplementFile] — Returns [] if no DOI. Calls _fetch_from_crossref().                                │
│ - list_supplements(pmid, doi) — Alias for fetch().                                                                              │
│ - _fetch_from_crossref(doi, pmid) — @api_retry. Queries https://api.crossref.org/works/{doi}. Handles 404 gracefully.           │
│ - _extract_supplements(message, doi, pmid) — Two strategies:                                                                    │
│   a. Parse message["link"] array: filter out intended-application: "similarity-checking" and "text-mining". Accept links with   │
│ supplement keywords in URL or valid file extensions.                                                                            │
│   b. Parse message["relation"]["has-supplement"] for id-type: "uri" entries.                                                    │
│   - Deduplicate by normalized URL.                                                                                              │
│ - _rate_limit() — Enforce 0.1s minimum between requests (polite pool allows ~50 req/s).                                         │
│                                                                                                                                 │
│ Modify: gene_literature/supplements/unified.py                                                                                  │
│                                                                                                                                 │
│ - Import CrossRefSupplementFetcher                                                                                              │
│ - Add self.crossref_fetcher = CrossRefSupplementFetcher(timeout=timeout) in __init__                                            │
│ - Append to self._fetchers list after self.elsevier_fetcher                                                                     │
│                                                                                                                                 │
│ Modify: gene_literature/supplements/__init__.py                                                                                 │
│                                                                                                                                 │
│ - Add import and __all__ entry for CrossRefSupplementFetcher                                                                    │
│                                                                                                                                 │
│ No changes to orchestrator.py — CrossRef is automatically included via UnifiedSupplementFetcher.fetch_all().                    │
│                                                                                                                                 │
│ ---                                                                                                                             │
│ Task 2: Supplement Re-fetch Script                                                                                              │
│                                                                                                                                 │
│ New file: scripts/refetch_supplements.py                                                                                        │
│                                                                                                                                 │
│ CLI: python scripts/refetch_supplements.py [--gene KCNH2] [--dry-run] [--limit N] [--priority-sort] [--status]                  │
│                                                                                                                                 │
│ Flow:                                                                                                                           │
│                                                                                                                                 │
│ Phase 1: Discovery                                                                                                              │
│   scan_for_candidates(pmc_dir) -> List[RefetchCandidate]                                                                        │
│     - Glob *_FULL_CONTEXT.md                                                                                                    │
│     - Check for empty or missing {pmid}_supplements/                                                                            │
│     - estimate_supplement_likelihood() via parse_supplement_references()                                                        │
│     - Load PMCID mapping from successful_downloads.csv                                                                          │
│                                                                                                                                 │
│ Phase 2: ID Resolution                                                                                                          │
│   resolve_ids(candidates, pmcid_map, pmc_api)                                                                                   │
│     - PMCID from CSV first, then pmc_api.pmid_to_pmcid()                                                                        │
│     - DOI from pmc_api.get_doi_from_pmid()                                                                                      │
│     - Rate limited: 0.35s between PMC API calls                                                                                 │
│                                                                                                                                 │
│ Phase 3: Re-fetch (per paper)                                                                                                   │
│   refetch_one_paper(candidate, harvester, converter) -> (Status, msg, count)                                                    │
│     1. Remove empty supplement dir if exists (Task 3)                                                                           │
│     2. Call harvester.get_supplemental_files(pmcid, pmid, doi)                                                                  │
│        (runs full cascade: Unified[PMC+Elsevier+CrossRef] -> PMC HTML -> DOI scraping)                                          │
│     3. If no supplements: return SKIPPED, don't create dir (Task 3)                                                             │
│     4. Call process_supplement_files() to download + convert                                                                    │
│     5. If downloads all fail: remove empty dir (Task 3)                                                                         │
│     6. Append supplement markdown to FULL_CONTEXT.md with header:                                                               │
│        "# ===== SUPPLEMENTS (RE-FETCHED) ====="                                                                                 │
│     7. Save to manifest after each paper (atomic, enables resume)                                                               │
│     8. 2s delay between papers                                                                                                  │
│                                                                                                                                 │
│ Phase 4: Summary statistics                                                                                                     │
│                                                                                                                                 │
│ Key components:                                                                                                                 │
│ - RefetchCandidate dataclass: pmid, paths, pmcid, doi, supplement_ref_count, priority_score                                     │
│ - find_latest_pmc_dir(output_dir, gene) — Auto-detects most recent run directory                                                │
│ - load_or_create_manifest(pmc_dir) — Resume support via utils/manifest.py                                                       │
│ - get_already_processed(manifest) — Skip PMIDs already successfully re-fetched                                                  │
│ - Idempotency guard: check for # ===== SUPPLEMENTS (RE-FETCHED) ===== in FULL_CONTEXT before appending                          │
│                                                                                                                                 │
│ Reuses existing code (no duplication):                                                                                          │
│ - harvester.get_supplemental_files() — full cascade from orchestrator.py:593                                                    │
│ - process_supplement_files() — from harvesting/supplement_processing_service.py                                                 │
│ - harvester.download_supplement() — from orchestrator.py:736                                                                    │
│ - parse_supplement_references() — from harvesting/supplement_reference_parser.py                                                │
│ - Manifest, ManifestEntry, Status — from utils/manifest.py                                                                      │
│                                                                                                                                 │
│ ---                                                                                                                             │
│ Task 3: Empty Dir Cleanup (integrated into Task 2)                                                                              │
│                                                                                                                                 │
│ Three enforcement points in refetch_one_paper():                                                                                │
│ 1. Pre-fetch: shutil.rmtree() existing empty supplement dir before re-fetching                                                  │
│ 2. No supplements found: Return SKIPPED without calling process_supplement_files() (which creates the dir)                      │
│ 3. All downloads failed: Remove the dir that process_supplement_files().mkdir() created                                         │
│                                                                                                                                 │
│ Also add Stage.REFETCH to utils/manifest.py Stage enum for audit clarity (optional).                                            │
│                                                                                                                                 │
│ ---                                                                                                                             │
│ Files Modified/Created                                                                                                          │
│                                                                                                                                 │
│ ┌─────────────────────────────────────────────────┬────────┬───────────────────────────────────┐                                │
│ │                      File                       │ Action │           Lines Changed           │                                │
│ ├─────────────────────────────────────────────────┼────────┼───────────────────────────────────┤                                │
│ │ gene_literature/supplements/crossref_fetcher.py │ CREATE │ ~160 lines                        │                                │
│ ├─────────────────────────────────────────────────┼────────┼───────────────────────────────────┤                                │
│ │ gene_literature/supplements/unified.py          │ EDIT   │ +3 lines (import, init, list)     │                                │
│ ├─────────────────────────────────────────────────┼────────┼───────────────────────────────────┤                                │
│ │ gene_literature/supplements/__init__.py         │ EDIT   │ +2 lines (import, all)            │                                │
│ ├─────────────────────────────────────────────────┼────────┼───────────────────────────────────┤                                │
│ │ scripts/refetch_supplements.py                  │ CREATE │ ~280 lines                        │                                │
│ ├─────────────────────────────────────────────────┼────────┼───────────────────────────────────┤                                │
│ │ utils/manifest.py                               │ EDIT   │ +1 line (Stage.REFETCH, optional) │                                │
│ └─────────────────────────────────────────────────┴────────┴───────────────────────────────────┘                                │
│                                                                                                                                 │
│ ---                                                                                                                             │
│ Verification                                                                                                                    │
│                                                                                                                                 │
│ Unit test: CrossRef fetcher                                                                                                     │
│                                                                                                                                 │
│ # After implementation, test with a known DOI that has supplements in CrossRef                                                  │
│ python -c "                                                                                                                     │
│ from gene_literature.supplements.crossref_fetcher import CrossRefSupplementFetcher                                              │
│ f = CrossRefSupplementFetcher()                                                                                                 │
│ results = f.fetch('24667783', '10.1093/hmg/ddu018')                                                                             │
│ print(f'Found {len(results)} supplements')                                                                                      │
│ for r in results: print(f'  {r.name}: {r.url}')                                                                                 │
│ "                                                                                                                               │
│                                                                                                                                 │
│ Dry run: re-fetch script                                                                                                        │
│                                                                                                                                 │
│ python scripts/refetch_supplements.py --dry-run --priority-sort                                                                 │
│ # Expect: list of ~318 candidates with supplement ref counts                                                                    │
│                                                                                                                                 │
│ Small batch test                                                                                                                │
│                                                                                                                                 │
│ python scripts/refetch_supplements.py --limit 5 --priority-sort                                                                 │
│ # Verify:                                                                                                                       │
│ # 1. Empty dirs removed                                                                                                         │
│ # 2. New supplements downloaded                                                                                                 │
│ # 3. FULL_CONTEXT.md updated with RE-FETCHED header                                                                             │
│ # 4. Manifest saved at pmc_fulltext/refetch_manifest.json                                                                       │
│                                                                                                                                 │
│ Verify no new empty dirs                                                                                                        │
│                                                                                                                                 │
│ find /mnt/temp2/kronckbm/gvf_output/KCNH2/*/pmc_fulltext/ -maxdepth 1 -type d -name "*_supplements" -empty | wc -l              │
│                                                                                                                                 │
│ Check manifest status                                                                                                           │
│                                                                                                                                 │
│ python scripts/refetch_supplements.py --status                                                                                  │
│                                                                                                                                 │
│ ---                                                                                                                             │
│ Implementation Order                                                                                                            │
│                                                                                                                                 │
│ 1. crossref_fetcher.py (standalone, testable independently)                                                                     │
│ 2. Wire into unified.py + __init__.py (3 lines)                                                                                 │
│ 3. refetch_supplements.py (uses everything above)                                                                               │
│ 4. Test with --dry-run, then --limit 5, then full run                                                                           │
╰─────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────╯

● I'll implement this plan in order. Let me start by reading the existing files I need to understand.

● Read 6 files (ctrl+o to expand)                                                                                                  
   
● Now let me read the remaining files needed for the refetch script.                                                               
                                                                                                                                 
● Searched for 3 patterns, read 3 files (ctrl+o to expand)                                                                         
  
● Let me read a few more key sections.                                                                                             
                                                                                                                                 
● Searched for 4 patterns, read 3 files (ctrl+o to expand)                                                                         
  
● Now I have everything I need. Let me create the task list and start implementing.                                                
                                                                                                                                 
● Write(gene_literature/supplements/crossref_fetcher.py)                                                                           
  ⎿  Wrote 204 lines to gene_literature/supplements/crossref_fetcher.py
       1 """CrossRef supplement fetcher (Tier 2.5 - free, no API key required).                                                    
       2                                                                                                                           
       3 Uses the CrossRef REST API to discover supplementary materials via                                                        
       4 DOI metadata. CrossRef indexes supplement links from most major publishers.                                               
       5                                                                                                                           
       6 Polite pool: requests with a mailto: User-Agent get routed to faster servers                                              
       7 and higher rate limits (~50 req/s vs ~1 req/s).                                                                           
       8                                                                                                                         
       9 API docs: https://api.crossref.org/swagger-ui/index.html
      10 """
     … +194 lines (ctrl+o to expand)

● Now wire it into unified.py and __init__.py.                             
                                         
● Update(gene_literature/supplements/unified.py)                           
  ⎿  Added 1 line                        
      17  from typing import Dict, List, Optional           
      18                               
      19  from .base import SupplementFetcher, SupplementFile                                                                      
      20 +from .crossref_fetcher import CrossRefSupplementFetcher                                                           
      21  from .elsevier_fetcher import ElsevierSupplementFetcher                                                                  
      22  from .pmc_fetcher import PMCSupplementFetcher                                                                          
      23                                                                                                                           
                                                                                                                                 
● Update(gene_literature/supplements/unified.py)                           
  ⎿  Added 2 lines                       
      35          self.timeout = timeout                    
      36          self.pmc_fetcher = PMCSupplementFetcher(timeout=timeout)
      37          self.elsevier_fetcher = ElsevierSupplementFetcher(timeout=timeout)
      38 +        self.crossref_fetcher = CrossRefSupplementFetcher(timeout=timeout)                                        
      39                                                                                                                           
      40          # Ordered list of fetchers to try
      41          self._fetchers: List[SupplementFetcher] = [                                                                      
      42              self.pmc_fetcher,                                                                                          
      43              self.elsevier_fetcher,
      44 +            self.crossref_fetcher,                                                                                
      45          ]
      46  
      47      def fetch_all(self, pmid: str, doi: str = "") -> List[SupplementFile]:

● Now update __init__.py:                                                  
                                         
● Update(gene_literature/supplements/__init__.py)                          
  ⎿  Added 2 lines                       
      14  """                                               
      15                               
      16  from .base import SupplementFetcher, SupplementFile                                                                      
      17 +from .crossref_fetcher import CrossRefSupplementFetcher                                                           
      18  from .elsevier_fetcher import ElsevierSupplementFetcher                                                                  
      19  from .pmc_fetcher import PMCSupplementFetcher                                                                          
      20  from .unified import UnifiedSupplementFetcher                                                                            
     ...                                                                                                                         
      24      "SupplementFile",
      25      "PMCSupplementFetcher",
      26      "ElsevierSupplementFetcher",
      27 +    "CrossRefSupplementFetcher",                                                                                  
      28      "UnifiedSupplementFetcher",
      29  ]

● Update(utils/manifest.py)                                                
  ⎿  Added 1 line                        
      37      SCOUT = "scout"                               
      38      EXTRACT = "extract"      
      39      MIGRATE = "migrate"          
      40 +    REFETCH = "refetch"                                                                                           
      41                                                                                                                           
      42  
      43  @dataclass                                                                                                               
                                                                                                                                 
● Now for the main refetch script. Let me check one more detail — the _process_supplements method and how download_supplement is
  called.                                                   
                                                              
● Searched for 1 pattern, read 1 file (ctrl+o to expand)     
                                           
● Now I have everything I need to write the refetch script.   
                                                                                                                                   
● Write(scripts/refetch_supplements.py)                       
  ⎿  Wrote 475 lines to scripts/refetch_supplements.py                                                                             
       1 #!/usr/bin/env python3                                                                                                  
       2 """                                                                                                                       
       3 Re-fetch supplements for papers with empty or missing supplement directories.                                             
       4 
       5 Runs the full supplement cascade (Unified[PMC+Elsevier+CrossRef] -> PMC HTML                                              
       6 -> DOI scraping) on papers that were originally processed before the pipeline                                           
       7 improvements were in place.                                                                                               
       8                                                                                                                         
       9 Usage:
      10     python scripts/refetch_supplements.py                      # Full run
     … +465 lines (ctrl+o to expand)

● All four files are done. Let me verify the imports work correctly.
                                           
● Bash(python -c "from gene_literature.supplements.crossref_fetcher import CrossRefSupplementFetcher; print('crossref_fetcher:
      OK')")                                                
  ⎿  Error: Exit code 1                                                                                                            
     Traceback (most recent call last):                     
       File "<string>", line 1, in <module>                                                                                        
       File "gene_literature/__init__.py", line 13, in <module>                                                                  
         from .discovery import discover_pmids_for_gene                                                                            
       File "gene_literature/discovery.py", line 24                                                                                
         pubmind_pmids: List[str]                                                                                                  
                      ^                                                                                                            
     SyntaxError: invalid syntax                                                                                                   
                                                                                                                                   
● Bash(python -c "from gene_literature.supplements import CrossRefSupplementFetcher, UnifiedSupplementFetcher; u =                 
      UnifiedSupplementFetcher(); print(f'Unified has {len…)                                                                       
  ⎿  Error: Sibling tool call errored                                                                                           
                                                                                                                                   
● Bash(python -c "from utils.manifest import Stage; print(f'Stages: {[s.value for s in Stage]}')")                               
  ⎿  Error: Sibling tool call errored                                                                                              

● The SyntaxError is a pre-existing issue in gene_literature/discovery.py (not my change). Let me test the imports directly        
  bypassing the package __init__:                                                                                                  
                                                                                                                                   
● Bash(python -c "                                                                                                                 
      import sys; sys.path.insert(0, '.')…)                                                                                        
  ⎿  Error: Exit code 1                                                                                                            
       File "<string>", line 6
         print(f'  API base: {f.API_BASE}')                                                                                        
                                         ^                                                                                       
     SyntaxError: invalid syntax                                                                                                   
   
● Bash(python -c "                                                                                                                 
      import sys; sys.path.insert(0, '.')…)                                                                                      
  ⎿  Error: Sibling tool call errored                                                                                              
   
● Bash(python -c "                                                                                                                 
      from utils.manifest import Stage…)                                                                                         
  ⎿  Error: Sibling tool call errored                                                                                              
   
● Bash(python -c "                                                                                                                 
      import sys; sys.path.insert(0, '.')…)                                                                                      
  ⎿  Error: Exit code 1                                                                                                            
     Traceback (most recent call last):
       File "<string>", line 3, in <module>                                                                                        
       File "./gene_literature/__init__.py", line 13, in <module>                                                                
         from .discovery import discover_pmids_for_gene                                                                            
       File "./gene_literature/discovery.py", line 24
         pubmind_pmids: List[str]                                                                                                  
                      ^                                                                                                          
     SyntaxError: invalid syntax

● The gene_literature/__init__.py is importing everything. Let me check which Python version is running, and import the submodule
  directly.
                                                                                                                                   
● Bash(python3 --version && python --version)        
  ⎿  Python 3.9.25                                                                                                                 
     Python 2.7.2                                                                                                                  
                                                     
● Python 2.7 is the default python! The project uses Python 3. Let me retest with python3:                                         
                                                                                                                                   
● Bash(python3 -c "                                                                                                                
      import sys; sys.path.insert(0, '.')…)                                                                                        
  ⎿  Error: Exit code 1                                                                                                            
     Traceback (most recent call last):                                                                                          
       File "<string>", line 3, in <module>                                                                                        
       File "/mnt/temp2/kronckbm/gitrepos/GeneVariantFetcher/./gene_literature/__init__.py", line 13, in <module>                
         from .discovery import discover_pmids_for_gene                                                                            
       File "/mnt/temp2/kronckbm/gitrepos/GeneVariantFetcher/./gene_literature/discovery.py", line 10, in <module>
         from config.settings import Settings, get_settings                                                                        
       File "/mnt/temp2/kronckbm/gitrepos/GeneVariantFetcher/./config/settings.py", line 8, in <module>                          
         from pydantic import Field, field_validator, model_validator
     ModuleNotFoundError: No module named 'pydantic'

● Bash(python3 -c "                                 
      from gene_literature.supplements.unified import UnifiedSupplementFetcher…)
  ⎿  Error: Sibling tool call errored                                                                                              
  
● Bash(python3 -c "                                                                                                                
      from utils.manifest import Stage…)                                                                                         
  ⎿  Error: Sibling tool call errored                                                                                              
  
● Bash(which python3 && pip3 list 2>/dev/null | head -5 || conda list 2>/dev/null | head -5 || echo "No pip/conda found")          
  ⎿  /programs/x86_64-linux/system/sbgrid_bin/python3                                                                            
     Package                   Version     Editable project location                                                               
     ------------------------- ----------- ------------------------------------------------------                                  
     … +3 lines (ctrl+o to expand)                                                                                                 
  ⎿  You've hit your limit · resets Feb 15, 9am (America/Chicago)                                                                  
     /extra-usage to finish what you’re working on.                                                                                
                                                                                                                                   
✻ Worked for 4m 10s                                                                                                                
                                                                                                                                   
❯ /extra-usage                                                                                                                     
  ⎿  Login interrupted 
