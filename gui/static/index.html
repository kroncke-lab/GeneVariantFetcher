<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeneVariantFetcher</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --warning: #ca8a04;
            --error: #dc2626;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--gray-50);
            color: var(--gray-900);
            line-height: 1.5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 1rem 0;
            margin-bottom: 2rem;
        }

        header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
        }

        header h1 {
            font-size: 1.5rem;
            color: var(--gray-900);
        }

        header h1 span {
            color: var(--primary);
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
        }

        .nav-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: transparent;
            color: var(--gray-500);
            cursor: pointer;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .nav-tab:hover {
            background: var(--gray-100);
            color: var(--gray-700);
        }

        .nav-tab.active {
            background: var(--primary);
            color: white;
        }

        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--gray-900);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.25rem;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"] {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
        }

        .checkbox-group label {
            margin-bottom: 0;
        }

        .collapsible {
            border: 1px solid var(--gray-200);
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .collapsible-header {
            padding: 0.75rem 1rem;
            background: var(--gray-50);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .collapsible-header:hover {
            background: var(--gray-100);
        }

        .collapsible-content {
            padding: 1rem;
            display: none;
        }

        .collapsible.open .collapsible-content {
            display: block;
        }

        .collapsible-header::after {
            content: '+';
            font-weight: bold;
        }

        .collapsible.open .collapsible-header::after {
            content: '-';
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-warning {
            background: var(--warning);
            color: white;
        }

        .btn-danger {
            background: var(--error);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-pending { background: var(--gray-200); color: var(--gray-700); }
        .status-running { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #dcfce7; color: #166534; }
        .status-failed { background: #fee2e2; color: #991b1b; }

        .job-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .job-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid var(--gray-200);
            border-radius: 0.375rem;
            background: white;
        }

        .job-item:hover {
            border-color: var(--gray-300);
        }

        .job-info {
            flex: 1;
        }

        .job-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .job-meta {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .job-actions {
            display: flex;
            gap: 0.5rem;
        }

        .progress-section {
            margin-top: 1.5rem;
        }

        .progress-steps {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
        }

        .progress-step.completed {
            color: var(--success);
        }

        .progress-step.active {
            background: #dbeafe;
            color: var(--primary);
        }

        .progress-step.pending {
            color: var(--gray-400);
        }

        .step-icon {
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 0.75rem;
        }

        .completed .step-icon {
            background: var(--success);
            color: white;
        }

        .active .step-icon {
            background: var(--primary);
            color: white;
        }

        .pending .step-icon {
            background: var(--gray-200);
            color: var(--gray-500);
        }

        .log-viewer {
            background: var(--gray-900);
            color: #10b981;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            padding: 1rem;
            border-radius: 0.375rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-line {
            margin-bottom: 0.25rem;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            text-align: center;
            padding: 1rem;
            background: var(--gray-50);
            border-radius: 0.375rem;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.375rem;
            margin-bottom: 1rem;
        }

        .alert-warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
        }

        .alert-error {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        .hidden {
            display: none !important;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            header .container {
                flex-direction: column;
                gap: 1rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }
        }

        /* Settings Page Styles */
        .settings-group {
            border: 1px solid var(--gray-200);
            border-radius: 0.5rem;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            background: var(--gray-50);
        }

        .settings-group-title {
            font-size: 1rem;
            font-weight: 600;
            margin: 0 0 0.25rem 0;
            color: var(--gray-900);
        }

        .settings-group-desc {
            font-size: 0.8rem;
            color: var(--gray-500);
            margin: 0 0 1rem 0;
        }

        .form-help {
            display: block;
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
        }

        .input-with-button {
            display: flex;
            gap: 0.5rem;
        }

        .input-with-button input {
            flex: 1;
        }

        .env-file-info {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--gray-200);
            color: var(--gray-500);
        }

        .env-file-info code {
            background: var(--gray-100);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.8rem;
        }

        .alert-success {
            background: #dcfce7;
            border: 1px solid #16a34a;
            color: #166534;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal.hidden {
            display: none;
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            position: relative;
            background: white;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.125rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray-500);
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: var(--gray-700);
        }

        .modal-body {
            padding: 1rem 1.5rem;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--gray-200);
        }

        /* Directory Browser Styles */
        .dir-shortcuts {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .dir-shortcut {
            padding: 0.375rem 0.75rem;
            background: var(--gray-100);
            border: 1px solid var(--gray-200);
            border-radius: 0.375rem;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .dir-shortcut:hover {
            background: var(--gray-200);
        }

        .dir-path {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }

        .dir-path-input {
            flex: 1;
            padding: 0.5rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-family: monospace;
            font-size: 0.875rem;
        }

        .dir-listing {
            border: 1px solid var(--gray-200);
            border-radius: 0.375rem;
            max-height: 300px;
            overflow-y: auto;
            background: white;
        }

        .dir-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--gray-100);
        }

        .dir-item:last-child {
            border-bottom: none;
        }

        .dir-item:hover {
            background: var(--gray-50);
        }

        .dir-item.selected {
            background: #dbeafe;
        }

        .dir-item-icon {
            font-size: 1rem;
        }

        .dir-item-name {
            flex: 1;
            font-size: 0.875rem;
        }

        .dir-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .dir-new-folder {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .dir-new-folder input {
            flex: 1;
            padding: 0.375rem 0.75rem;
            border: 1px solid var(--gray-300);
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .btn-sm {
            padding: 0.375rem 0.75rem;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            color: var(--gray-500);
            padding: 2rem;
        }

        /* Info icon tooltips */
        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            background: var(--gray-200);
            color: var(--gray-600);
            border-radius: 50%;
            font-size: 11px;
            font-weight: 600;
            cursor: help;
            margin-left: 6px;
            position: relative;
            vertical-align: middle;
            transition: background 0.2s, color 0.2s;
        }

        .info-icon:hover {
            background: var(--primary);
            color: white;
        }

        .info-tooltip {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--gray-800);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 400;
            line-height: 1.4;
            white-space: normal;
            width: 280px;
            text-align: left;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            pointer-events: none;
        }

        .info-tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: var(--gray-800);
        }

        .info-icon:hover .info-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .label-with-info {
            display: flex;
            align-items: center;
        }

        .setting-description {
            font-size: 0.75rem;
            color: var(--gray-500);
            margin-top: 0.25rem;
            line-height: 1.4;
        }

        .settings-subsection {
            margin-top: 1rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--gray-200);
        }

        .settings-subsection h4 {
            margin: 0 0 0.5rem;
            font-size: 0.875rem;
            color: var(--gray-700);
        }

        /* Job Mode Toggle */
        .job-mode-btn {
            background: var(--gray-100);
            color: var(--gray-600);
            border: 1px solid var(--gray-200);
        }

        .job-mode-btn:hover {
            background: var(--gray-200);
            color: var(--gray-700);
        }

        .job-mode-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Folder Analysis Styles */
        .analysis-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .analysis-stat {
            text-align: center;
            padding: 0.75rem;
            background: white;
            border-radius: 0.375rem;
            border: 1px solid var(--gray-200);
        }

        .analysis-stat-value {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary);
        }

        .analysis-stat-label {
            font-size: 0.75rem;
            color: var(--gray-500);
        }

        .analysis-status {
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
        }

        .analysis-status.ready {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #16a34a;
        }

        .analysis-status.needs-scout {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .analysis-status.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .analysis-status.interrupted {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        /* Pipeline Breakdown Styles */
        .pipeline-breakdown {
            margin-top: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 0.375rem;
            border: 1px solid var(--gray-200);
        }

        .pipeline-breakdown-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            color: var(--gray-700);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pipeline-breakdown-title .icon {
            font-size: 1rem;
        }

        .pipeline-stages {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .pipeline-stage {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 0.75rem;
            background: white;
            border-radius: 0.25rem;
            border: 1px solid var(--gray-200);
            font-size: 0.8125rem;
        }

        .pipeline-stage-name {
            color: var(--gray-600);
            font-weight: 500;
        }

        .pipeline-stage-counts {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .pipeline-stage-count {
            text-align: center;
        }

        .pipeline-stage-count .value {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .pipeline-stage-count .label {
            font-size: 0.6875rem;
            color: var(--gray-500);
        }

        .pipeline-stage-count.success .value {
            color: #16a34a;
        }

        .pipeline-stage-count.warning .value {
            color: #f59e0b;
        }

        .pipeline-stage-count.error .value {
            color: #dc2626;
        }

        .pipeline-stage-count.neutral .value {
            color: var(--gray-600);
        }

        .pipeline-gap-alert {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 0.375rem;
            font-size: 0.8125rem;
            color: #92400e;
        }

        .pipeline-gap-alert strong {
            display: block;
            margin-bottom: 0.25rem;
        }

        .pipeline-collapsible {
            cursor: pointer;
            user-select: none;
        }

        .pipeline-collapsible::after {
            content: ' [show details]';
            font-size: 0.75rem;
            color: var(--primary);
        }

        .pipeline-collapsible.open::after {
            content: ' [hide details]';
        }

        .pipeline-details {
            display: none;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f3f4f6;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .pipeline-details.open {
            display: block;
        }

        .pipeline-pmid-list {
            font-family: monospace;
            word-break: break-all;
            color: var(--gray-600);
        }

        .analysis-recommendations {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .analysis-recommendations li {
            padding: 0.25rem 0;
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .analysis-recommendations li::before {
            content: 'â†’ ';
            color: var(--primary);
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Gene<span>Variant</span>Fetcher</h1>
            <nav class="nav-tabs">
                <button class="nav-tab active" data-tab="new-job">New Job</button>
                <button class="nav-tab" data-tab="jobs">Jobs</button>
                <button class="nav-tab" data-tab="active" id="active-tab">Active <span id="active-count"></span></button>
                <button class="nav-tab" data-tab="settings">Settings</button>
            </nav>
        </div>
    </header>

    <main class="container">
        <!-- Incomplete Jobs Alert -->
        <div id="incomplete-alert" class="alert alert-warning hidden">
            <strong>Incomplete Jobs Found!</strong>
            <span id="incomplete-message"></span>
            <button class="btn btn-warning btn-sm" onclick="showTab('jobs')">View Jobs</button>
        </div>

        <!-- New Job Tab -->
        <section id="tab-new-job" class="tab-content">
            <!-- Mode Toggle -->
            <div class="card" style="padding: 0.75rem 1.5rem;">
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <span style="font-weight: 500; color: var(--gray-700);">Mode:</span>
                    <button type="button" class="btn btn-sm job-mode-btn active" data-mode="new" onclick="setJobMode('new')">
                        New Pipeline
                    </button>
                    <button type="button" class="btn btn-sm job-mode-btn" data-mode="folder" onclick="setJobMode('folder')">
                        Import Existing Folder
                    </button>
                </div>
            </div>

            <!-- New Job Form (existing) -->
            <div id="new-job-panel" class="card">
                <h2 class="card-title">Start New Extraction</h2>
                <form id="job-form">
                    <!-- Basic Settings -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="gene">Gene Symbol *</label>
                            <input type="text" id="gene" name="gene_symbol" required placeholder="e.g., BRCA1, SCN5A">
                        </div>
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" required placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label for="output">Output Directory *</label>
                            <input type="text" id="output" name="output_dir" required value="./output">
                        </div>
                    </div>

                    <!-- Pipeline Limits -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="max-pmids">Max PMIDs</label>
                            <input type="number" id="max-pmids" name="max_pmids" value="100" min="1" max="20000">
                        </div>
                        <div class="form-group">
                            <label for="max-downloads">Max Downloads</label>
                            <input type="number" id="max-downloads" name="max_papers_to_download" value="50" min="1" max="1000">
                        </div>
                    </div>

                    <!-- Specific PMIDs for Testing -->
                    <div class="form-group">
                        <div class="label-with-info">
                            <label for="specific-pmids">Specific PMIDs (for testing)</label>
                            <span class="info-icon">i
                                <span class="info-tooltip">Enter specific PMID(s) to skip the discovery step and process only these papers. Useful for testing or re-processing specific articles. Leave empty to run full discovery.</span>
                            </span>
                        </div>
                        <input type="text" id="specific-pmids" name="specific_pmids" placeholder="e.g., 12345678, 23456789 (comma-separated)">
                        <small class="setting-description">Leave empty for full discovery, or enter PMIDs to process specific papers</small>
                    </div>

                    <!-- Synonym Settings -->
                    <div class="form-row">
                        <div class="form-group">
                            <div class="checkbox-group">
                                <input type="checkbox" id="auto-synonyms" name="auto_synonyms">
                                <label for="auto-synonyms">Auto-discover gene synonyms</label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="synonyms">Manual Synonyms (comma-separated)</label>
                            <input type="text" id="synonyms" name="synonyms" placeholder="e.g., hERG, KCNH2">
                        </div>
                    </div>

                    <!-- Advanced Settings (Collapsible) -->
                    <div class="collapsible">
                        <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                            Advanced Settings
                        </div>
                        <div class="collapsible-content">
                            <!-- Extraction Configuration -->
                            <div class="form-row">
                                <div class="form-group">
                                    <div class="label-with-info">
                                        <label for="tier-threshold">Tier Threshold</label>
                                        <span class="info-icon">i
                                            <span class="info-tooltip">Controls the model cascade behavior. If the first LLM model finds fewer variants than this threshold, the system automatically retries with the next model in the cascade. Set to 0 to use only a single model. Higher values (1-10) make the system more aggressive about trying additional models.</span>
                                        </span>
                                    </div>
                                    <input type="number" id="tier-threshold" name="tier_threshold" value="1" min="0" max="10">
                                    <small class="setting-description">0 = single model, higher = retry if few variants found</small>
                                </div>
                                <div class="form-group">
                                    <div class="label-with-info">
                                        <label for="confidence">Filter Confidence Threshold</label>
                                        <span class="info-icon">i
                                            <span class="info-tooltip">The minimum confidence score (0.0-1.0) required for the Tier 2 LLM filter to consider a paper relevant. Papers scoring below this threshold are excluded from extraction. Lower values include more papers but may increase noise; higher values are more selective.</span>
                                        </span>
                                    </div>
                                    <input type="number" id="confidence" name="tier2_confidence_threshold" value="0.5" min="0" max="1" step="0.1">
                                    <small class="setting-description">Papers scoring below this are excluded</small>
                                </div>
                            </div>

                            <!-- Filter Controls -->
                            <div class="settings-subsection">
                                <h4>Paper Filtering Pipeline</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="enable-tier1" name="enable_tier1" checked>
                                            <label for="enable-tier1">Enable Tier 1 (Keyword Filter)</label>
                                            <span class="info-icon">i
                                                <span class="info-tooltip">Fast initial filter using keyword matching to quickly eliminate obviously irrelevant papers. Searches for gene names, variant patterns, and phenotype-related terms. Recommended to keep enabled for faster processing.</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="enable-tier2" name="enable_tier2" checked>
                                            <label for="enable-tier2">Enable Tier 2 (LLM Filter)</label>
                                            <span class="info-icon">i
                                                <span class="info-tooltip">Uses an LLM to intelligently assess whether papers contain extractable variant carrier data. More accurate than keyword filtering but slower and uses API credits. Applies the confidence threshold setting above.</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="clinical-triage" name="use_clinical_triage">
                                            <label for="clinical-triage">Use Clinical Triage Filter</label>
                                            <span class="info-icon">i
                                                <span class="info-tooltip">Additional filter that prioritizes papers with clinical relevance (case reports, clinical studies, patient cohorts). Enable this if you're specifically interested in clinical variant data rather than functional studies.</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Literature Sources -->
                            <div class="settings-subsection">
                                <h4>Literature Sources</h4>
                                <div class="form-row">
                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="use-pubmind" name="use_pubmind" checked>
                                            <label for="use-pubmind">PubMind</label>
                                            <span class="info-icon">i
                                                <span class="info-tooltip">AI-powered literature discovery service that finds gene-relevant papers using semantic search. Often finds papers that keyword-based searches miss. Recommended as a primary source.</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="use-pubmed" name="use_pubmed" checked>
                                            <label for="use-pubmed">PubMed</label>
                                            <span class="info-icon">i
                                                <span class="info-tooltip">NCBI's comprehensive biomedical literature database. Uses standard keyword and MeSH term searches. Good for broad coverage of published literature.</span>
                                            </span>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <div class="checkbox-group">
                                            <input type="checkbox" id="use-europepmc" name="use_europepmc">
                                            <label for="use-europepmc">Europe PMC</label>
                                            <span class="info-icon">i
                                                <span class="info-tooltip">European literature database that includes preprints and additional European sources not always in PubMed. Can provide supplementary results but may have some overlap with PubMed.</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Optimization -->
                            <div class="settings-subsection">
                                <h4>Performance Optimization</h4>
                                <div class="form-group">
                                    <div class="checkbox-group">
                                        <input type="checkbox" id="scout-enabled" name="scout_enabled" checked>
                                        <label for="scout-enabled">Enable DATA_ZONES condensation</label>
                                        <span class="info-icon">i
                                            <span class="info-tooltip">Pre-processes papers to identify and extract only the relevant sections (tables, results, methods) before sending to the LLM. Significantly reduces token usage and speeds up extraction. Disable only if you're seeing missing data that might be in unusual document locations.</span>
                                        </span>
                                    </div>
                                    <small class="setting-description">Faster extraction by focusing on relevant document sections</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary">Start Pipeline</button>
                </form>
            </div>

            <!-- Folder Import Panel (hidden by default) -->
            <div id="folder-job-panel" class="card hidden">
                <h2 class="card-title">Extract from Existing Folder</h2>
                <p style="color: var(--gray-500); margin-bottom: 1rem; font-size: 0.875rem;">
                    Select a folder containing downloaded manuscripts (_FULL_CONTEXT.md files) to run extraction without re-downloading.
                </p>

                <form id="folder-job-form">
                    <!-- Folder Selection -->
                    <div class="form-group">
                        <label for="folder-path">Folder Path *</label>
                        <div class="input-with-button">
                            <input type="text" id="folder-path" name="folder_path" required placeholder="/path/to/output/GENE/timestamp">
                            <button type="button" class="btn btn-secondary" onclick="openDirectoryBrowser('folder-path')">Browse</button>
                            <button type="button" class="btn btn-secondary" onclick="analyzeFolder()">Analyze</button>
                        </div>
                    </div>

                    <!-- Folder Analysis Results -->
                    <div id="folder-analysis" class="hidden" style="margin-bottom: 1rem;">
                        <div class="settings-group">
                            <h3 class="settings-group-title">Folder Analysis</h3>
                            <div id="folder-analysis-content"></div>
                        </div>
                    </div>

                    <!-- Gene Symbol (auto-detected or manual) -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="folder-gene">Gene Symbol *</label>
                            <input type="text" id="folder-gene" name="gene_symbol" required placeholder="e.g., SCN5A">
                            <small class="form-help">Auto-detected from folder if possible</small>
                        </div>
                        <div class="form-group">
                            <label for="folder-email">Email *</label>
                            <input type="email" id="folder-email" name="email" required placeholder="your@email.com">
                        </div>
                    </div>

                    <!-- Scouting Options -->
                    <div class="settings-group">
                        <h3 class="settings-group-title">Data Scout Options</h3>
                        <p class="settings-group-desc">
                            Data Scout identifies high-value sections in papers, reducing extraction time by 60-80%.
                        </p>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="run-scout" name="run_scout">
                                    <label for="run-scout">Run Data Scout on unscouted papers</label>
                                    <span class="info-icon">i
                                        <span class="info-tooltip">Creates DATA_ZONES.md files for papers that only have FULL_CONTEXT.md. This condenses papers to relevant sections before extraction, reducing API costs and improving accuracy.</span>
                                    </span>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="skip-extracted" name="skip_already_extracted" checked>
                                    <label for="skip-extracted">Skip already-extracted papers</label>
                                    <span class="info-icon">i
                                        <span class="info-tooltip">If the folder already has some extractions, skip those PMIDs and only extract new papers. Uncheck to re-extract everything.</span>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings (Collapsible) -->
                    <div class="collapsible">
                        <div class="collapsible-header" onclick="this.parentElement.classList.toggle('open')">
                            Advanced Extraction Settings
                        </div>
                        <div class="collapsible-content">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="folder-tier-threshold">Tier Threshold</label>
                                    <input type="number" id="folder-tier-threshold" name="tier_threshold" value="1" min="0" max="10">
                                    <small class="setting-description">Model cascade threshold (0 = single model)</small>
                                </div>
                                <div class="form-group">
                                    <label for="folder-scout-relevance">Scout Min Relevance</label>
                                    <input type="number" id="folder-scout-relevance" name="scout_min_relevance" value="0.3" min="0" max="1" step="0.1">
                                    <small class="setting-description">Minimum relevance score for data zones</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary" id="folder-submit-btn" disabled>
                        Start Extraction
                    </button>
                </form>
            </div>
        </section>

        <!-- Jobs List Tab -->
        <section id="tab-jobs" class="tab-content hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="card-title" style="margin: 0;">All Jobs</h2>
                    <button class="btn btn-secondary" onclick="loadJobs()">Refresh</button>
                </div>
                <div id="jobs-list" class="job-list">
                    <p style="color: var(--gray-500); text-align: center;">Loading jobs...</p>
                </div>
            </div>
        </section>

        <!-- Active Job Tab -->
        <section id="tab-active" class="tab-content hidden">
            <div id="no-active-job" class="card">
                <p style="text-align: center; color: var(--gray-500);">No active job. Start a new extraction or resume an incomplete job.</p>
            </div>

            <div id="active-job-content" class="hidden">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 class="card-title" style="margin: 0;" id="active-job-title">Job</h2>
                            <p class="job-meta" id="active-job-meta"></p>
                        </div>
                        <div>
                            <span class="status-badge" id="active-job-status">Running</span>
                            <button class="btn btn-danger" id="stop-btn" onclick="stopJob()">Stop</button>
                        </div>
                    </div>
                </div>

                <!-- Progress Steps -->
                <div class="card">
                    <h3 class="card-title">Progress</h3>
                    <div class="progress-steps" id="progress-steps"></div>
                </div>

                <!-- Statistics -->
                <div class="card">
                    <h3 class="card-title">Statistics</h3>
                    <div class="stats-grid" id="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="stat-pmids">-</div>
                            <div class="stat-label">PMIDs Found</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-filtered">-</div>
                            <div class="stat-label">Passed Filters</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-downloaded">-</div>
                            <div class="stat-label">Downloaded</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-extracted">-</div>
                            <div class="stat-label">Extracted</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="stat-variants">-</div>
                            <div class="stat-label">Total Variants</div>
                        </div>
                    </div>
                </div>

                <!-- Log Viewer -->
                <div class="card">
                    <h3 class="card-title">Logs</h3>
                    <div class="log-viewer" id="log-viewer"></div>
                </div>

                <!-- Results (shown when complete) -->
                <div class="card hidden" id="results-card">
                    <h3 class="card-title">Results</h3>
                    <div id="results-content"></div>
                </div>
            </div>
        </section>

        <!-- Settings Tab -->
        <section id="tab-settings" class="tab-content hidden">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 class="card-title" style="margin: 0;">Environment Settings</h2>
                    <div>
                        <button class="btn btn-secondary" onclick="loadSettings()">Reload</button>
                        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                    </div>
                </div>

                <!-- Validation Status -->
                <div id="settings-validation" class="alert hidden"></div>

                <!-- Settings Form -->
                <form id="settings-form">
                    <!-- API Keys Group -->
                    <div class="settings-group">
                        <h3 class="settings-group-title">API Keys</h3>
                        <p class="settings-group-desc">Required credentials for accessing external services.</p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="setting-OPENAI_API_KEY">OpenAI API Key *</label>
                                <input type="password" id="setting-OPENAI_API_KEY" name="OPENAI_API_KEY" placeholder="sk-...">
                                <small class="form-help">Required for variant extraction</small>
                            </div>
                            <div class="form-group">
                                <label for="setting-ANTHROPIC_API_KEY">Anthropic API Key</label>
                                <input type="password" id="setting-ANTHROPIC_API_KEY" name="ANTHROPIC_API_KEY" placeholder="sk-ant-...">
                                <small class="form-help">Optional, for Claude models</small>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="setting-NCBI_EMAIL">NCBI Email *</label>
                                <input type="email" id="setting-NCBI_EMAIL" name="NCBI_EMAIL" placeholder="your@email.com">
                                <small class="form-help">Required for PubMed/NCBI API access</small>
                            </div>
                            <div class="form-group">
                                <label for="setting-NCBI_API_KEY">NCBI API Key</label>
                                <input type="password" id="setting-NCBI_API_KEY" name="NCBI_API_KEY" placeholder="Optional">
                                <small class="form-help">Increases rate limits (get from NCBI)</small>
                            </div>
                        </div>
                    </div>

                    <!-- Models Group -->
                    <div class="settings-group">
                        <h3 class="settings-group-title">Model Configuration</h3>
                        <p class="settings-group-desc">Configure the LLM models used for filtering and extraction.</p>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="setting-TIER2_MODEL">Tier 2 Filter Model</label>
                                <input type="text" id="setting-TIER2_MODEL" name="TIER2_MODEL" value="gpt-4o-mini">
                                <small class="form-help">Model for paper relevance filtering</small>
                            </div>
                            <div class="form-group">
                                <label for="setting-TIER3_MODELS">Tier 3 Extraction Models</label>
                                <input type="text" id="setting-TIER3_MODELS" name="TIER3_MODELS" value="gpt-4o-mini,gpt-4o">
                                <small class="form-help">Comma-separated list of models</small>
                            </div>
                        </div>
                    </div>

                    <!-- Pipeline Defaults Group -->
                    <div class="settings-group">
                        <h3 class="settings-group-title">Pipeline Defaults</h3>
                        <p class="settings-group-desc">Default settings for new extraction jobs.</p>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="setting-ENABLE_TIER1" name="ENABLE_TIER1" checked>
                                    <label for="setting-ENABLE_TIER1">Enable Tier 1 (Keyword Filter)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="setting-ENABLE_TIER2" name="ENABLE_TIER2" checked>
                                    <label for="setting-ENABLE_TIER2">Enable Tier 2 (LLM Filter)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="setting-TIER2_CONFIDENCE_THRESHOLD">Filter Confidence Threshold</label>
                                <input type="number" id="setting-TIER2_CONFIDENCE_THRESHOLD" name="TIER2_CONFIDENCE_THRESHOLD" value="0.5" min="0" max="1" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Literature Sources Group -->
                    <div class="settings-group">
                        <h3 class="settings-group-title">Literature Sources</h3>
                        <p class="settings-group-desc">Configure which databases to search for papers.</p>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="setting-USE_PUBMIND" name="USE_PUBMIND" checked>
                                    <label for="setting-USE_PUBMIND">Use PubMind</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="setting-USE_PUBMED" name="USE_PUBMED" checked>
                                    <label for="setting-USE_PUBMED">Use PubMed</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="setting-USE_EUROPEPMC" name="USE_EUROPEPMC">
                                    <label for="setting-USE_EUROPEPMC">Use Europe PMC</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Scout Configuration -->
                    <div class="settings-group">
                        <h3 class="settings-group-title">Data Scout</h3>
                        <p class="settings-group-desc">Genetic Data Scout creates condensed DATA_ZONES for faster extraction.</p>
                        <div class="form-row">
                            <div class="form-group">
                                <div class="checkbox-group">
                                    <input type="checkbox" id="setting-SCOUT_ENABLED" name="SCOUT_ENABLED" checked>
                                    <label for="setting-SCOUT_ENABLED">Enable DATA_ZONES (recommended)</label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="setting-SCOUT_MIN_RELEVANCE">Min Relevance Score</label>
                                <input type="number" id="setting-SCOUT_MIN_RELEVANCE" name="SCOUT_MIN_RELEVANCE" value="0.3" min="0" max="1" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Output Configuration -->
                    <div class="settings-group">
                        <h3 class="settings-group-title">Output Configuration</h3>
                        <p class="settings-group-desc">Default output location for extraction results.</p>
                        <div class="form-row">
                            <div class="form-group" style="flex: 1;">
                                <label for="setting-DEFAULT_OUTPUT_DIR">Default Output Directory</label>
                                <div class="input-with-button">
                                    <input type="text" id="setting-DEFAULT_OUTPUT_DIR" name="DEFAULT_OUTPUT_DIR" value="./output">
                                    <button type="button" class="btn btn-secondary" onclick="openDirectoryBrowser('setting-DEFAULT_OUTPUT_DIR')">Browse</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>

                <!-- .env file info -->
                <div class="env-file-info" id="env-file-info">
                    <small>Settings are saved to: <code id="env-file-path">.env</code></small>
                </div>
            </div>
        </section>
    </main>

    <!-- Directory Browser Modal -->
    <div id="directory-modal" class="modal hidden">
        <div class="modal-backdrop" onclick="closeDirectoryBrowser()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Select Directory</h3>
                <button class="modal-close" onclick="closeDirectoryBrowser()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Shortcuts -->
                <div class="dir-shortcuts" id="dir-shortcuts"></div>

                <!-- Current path -->
                <div class="dir-path">
                    <button class="btn btn-secondary btn-sm" id="dir-up-btn" onclick="navigateUp()">Up</button>
                    <input type="text" id="dir-current-path" class="dir-path-input" onkeypress="if(event.key==='Enter')navigateToPath(this.value)">
                </div>

                <!-- Directory listing -->
                <div class="dir-listing" id="dir-listing">
                    <p class="loading">Loading...</p>
                </div>

                <!-- New folder -->
                <div class="dir-new-folder">
                    <input type="text" id="new-folder-name" placeholder="New folder name">
                    <button class="btn btn-secondary btn-sm" onclick="createNewFolder()">Create Folder</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDirectoryBrowser()">Cancel</button>
                <button class="btn btn-primary" onclick="selectDirectory()">Select</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let currentTab = 'new-job';
        let activeJobId = null;
        let websocket = null;

        const PIPELINE_STEPS = [
            { key: 'discovering_synonyms', label: 'Discovering Synonyms' },
            { key: 'fetching_pmids', label: 'Fetching PMIDs' },
            { key: 'fetching_abstracts', label: 'Fetching Abstracts' },
            { key: 'filtering_papers', label: 'Filtering Papers' },
            { key: 'downloading_fulltext', label: 'Downloading Full-Text' },
            { key: 'scouting_data', label: 'Scouting Data Zones' },
            { key: 'extracting_variants', label: 'Extracting Variants' },
            { key: 'aggregating_data', label: 'Aggregating Data' },
            { key: 'migrating_database', label: 'Creating Database' },
        ];

        // Folder job steps (subset)
        const FOLDER_PIPELINE_STEPS = [
            { key: 'scouting_data', label: 'Scouting Data Zones' },
            { key: 'extracting_variants', label: 'Extracting Variants' },
            { key: 'aggregating_data', label: 'Aggregating Data' },
            { key: 'migrating_database', label: 'Creating Database' },
        ];

        let currentJobMode = 'new';
        let lastFolderAnalysis = null;

        // Tab Navigation
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => showTab(tab.dataset.tab));
        });

        function showTab(tabName) {
            currentTab = tabName;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(`tab-${tabName}`).classList.remove('hidden');

            if (tabName === 'jobs') loadJobs();
            if (tabName === 'active' && activeJobId) connectWebSocket(activeJobId);
            if (tabName === 'settings') loadSettings();
        }

        // API Calls
        async function apiCall(method, endpoint, data = null) {
            const options = {
                method,
                headers: { 'Content-Type': 'application/json' },
            };
            if (data) options.body = JSON.stringify(data);

            const response = await fetch(`/api${endpoint}`, options);
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.detail || 'API error');
            }
            return response.json();
        }

        // Load Jobs
        async function loadJobs() {
            try {
                const data = await apiCall('GET', '/jobs');
                renderJobsList(data.jobs);

                // Check for incomplete jobs
                if (data.incomplete_count > 0) {
                    document.getElementById('incomplete-alert').classList.remove('hidden');
                    document.getElementById('incomplete-message').textContent =
                        `You have ${data.incomplete_count} job(s) that can be resumed.`;
                } else {
                    document.getElementById('incomplete-alert').classList.add('hidden');
                }
            } catch (err) {
                console.error('Failed to load jobs:', err);
            }
        }

        function renderJobsList(jobs) {
            const container = document.getElementById('jobs-list');

            if (jobs.length === 0) {
                container.innerHTML = '<p style="color: var(--gray-500); text-align: center;">No jobs found.</p>';
                return;
            }

            container.innerHTML = jobs.map(job => `
                <div class="job-item">
                    <div class="job-info">
                        <div class="job-title">${job.gene_symbol}</div>
                        <div class="job-meta">
                            ${job.job_id} | ${formatDate(job.created_at)} | ${job.current_step_display}
                        </div>
                    </div>
                    <div class="job-actions">
                        <span class="status-badge status-${getStatusClass(job.current_step)}">${job.current_step_display}</span>
                        ${job.is_resumable ? `<button class="btn btn-success" onclick="resumeJob('${job.job_id}')">Resume</button>` : ''}
                        ${job.current_step === 'completed' ? `<button class="btn btn-primary" onclick="viewResults('${job.job_id}')">Results</button>` : ''}
                        <button class="btn btn-secondary" onclick="viewJob('${job.job_id}')">View</button>
                        ${!isJobActive(job) ? `<button class="btn btn-danger" onclick="deleteJob('${job.job_id}')">Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function getStatusClass(step) {
            if (step === 'completed') return 'completed';
            if (step === 'failed') return 'failed';
            if (step === 'pending') return 'pending';
            return 'running';
        }

        function isJobActive(job) {
            return !['pending', 'completed', 'failed'].includes(job.current_step);
        }

        function formatDate(isoString) {
            return new Date(isoString).toLocaleString();
        }

        // Create Job
        document.getElementById('job-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {};

            formData.forEach((value, key) => {
                if (key === 'synonyms' || key === 'specific_pmids') {
                    // Parse comma-separated lists (synonyms and PMIDs)
                    data[key] = value ? value.split(',').map(s => s.trim()).filter(s => s) : [];
                } else if (['auto_synonyms', 'use_clinical_triage', 'enable_tier1', 'enable_tier2',
                           'use_pubmind', 'use_pubmed', 'use_europepmc', 'scout_enabled'].includes(key)) {
                    data[key] = true;
                } else if (['max_pmids', 'max_papers_to_download', 'tier_threshold'].includes(key)) {
                    data[key] = parseInt(value);
                } else if (key === 'tier2_confidence_threshold') {
                    data[key] = parseFloat(value);
                } else {
                    data[key] = value;
                }
            });

            // Handle unchecked checkboxes
            ['auto_synonyms', 'use_clinical_triage', 'enable_tier1', 'enable_tier2',
             'use_pubmind', 'use_pubmed', 'use_europepmc', 'scout_enabled'].forEach(key => {
                if (!(key in data)) data[key] = false;
            });

            // Ensure specific_pmids is set (even if empty)
            if (!('specific_pmids' in data)) data.specific_pmids = [];

            try {
                const job = await apiCall('POST', '/jobs', data);
                activeJobId = job.job_id;
                showTab('active');
                connectWebSocket(job.job_id);
            } catch (err) {
                alert('Failed to create job: ' + err.message);
            }
        });

        // Resume Job
        async function resumeJob(jobId) {
            try {
                await apiCall('POST', `/jobs/${jobId}/resume`);
                activeJobId = jobId;
                showTab('active');
                connectWebSocket(jobId);
            } catch (err) {
                alert('Failed to resume job: ' + err.message);
            }
        }

        // View Job
        function viewJob(jobId) {
            activeJobId = jobId;
            showTab('active');
            connectWebSocket(jobId);
        }

        // View Results
        async function viewResults(jobId) {
            try {
                const results = await apiCall('GET', `/jobs/${jobId}/results`);
                activeJobId = jobId;
                showTab('active');
                displayResults(results);
            } catch (err) {
                alert('Failed to load results: ' + err.message);
            }
        }

        // Delete Job
        async function deleteJob(jobId) {
            if (!confirm('Are you sure you want to delete this job?')) return;

            try {
                await apiCall('DELETE', `/jobs/${jobId}`);
                loadJobs();
            } catch (err) {
                alert('Failed to delete job: ' + err.message);
            }
        }

        // Stop Job
        async function stopJob() {
            if (!activeJobId) return;

            try {
                await apiCall('POST', `/jobs/${activeJobId}/stop`);
            } catch (err) {
                alert('Failed to stop job: ' + err.message);
            }
        }

        // Clear job view when starting a new job
        function clearJobView() {
            // Hide results card and clear content
            document.getElementById('results-card').classList.add('hidden');
            document.getElementById('results-content').innerHTML = '';

            // Reset all statistics to "-"
            document.getElementById('stat-pmids').textContent = '-';
            document.getElementById('stat-filtered').textContent = '-';
            document.getElementById('stat-downloaded').textContent = '-';
            document.getElementById('stat-extracted').textContent = '-';
            document.getElementById('stat-variants').textContent = '-';

            // Clear log viewer
            document.getElementById('log-viewer').innerHTML = '';

            // Reset progress steps
            document.getElementById('progress-steps').innerHTML = '';
        }

        // WebSocket Connection
        function connectWebSocket(jobId) {
            if (websocket) {
                websocket.close();
            }

            // Clear previous job's data when connecting to a new job
            clearJobView();

            document.getElementById('no-active-job').classList.add('hidden');
            document.getElementById('active-job-content').classList.remove('hidden');

            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            websocket = new WebSocket(`${protocol}//${window.location.host}/ws/${jobId}`);

            websocket.onopen = () => {
                console.log('WebSocket connected');
            };

            websocket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            websocket.onclose = () => {
                console.log('WebSocket disconnected');
            };

            websocket.onerror = (err) => {
                console.error('WebSocket error:', err);
            };

            // Ping to keep alive
            setInterval(() => {
                if (websocket && websocket.readyState === WebSocket.OPEN) {
                    websocket.send('ping');
                }
            }, 30000);
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'state':
                    updateJobState(data.job);
                    if (data.logs) {
                        data.logs.forEach(log => appendLog(log));
                    }
                    break;
                case 'step_start':
                case 'step_complete':
                    updateProgressStep(data.step, data.type === 'step_complete');
                    if (data.stats) updateStats(data.stats);
                    break;
                case 'log':
                    appendLog(data.message);
                    break;
                case 'error':
                    appendLog(`ERROR: ${data.error}`, true);
                    break;
                case 'job_complete':
                    updateJobComplete(data.status);
                    break;
            }
        }

        function updateJobState(job) {
            document.getElementById('active-job-title').textContent = job.gene_symbol;
            document.getElementById('active-job-meta').textContent =
                `Job: ${job.job_id} | Started: ${formatDate(job.created_at)}`;

            const statusBadge = document.getElementById('active-job-status');
            statusBadge.textContent = job.current_step_display;
            statusBadge.className = `status-badge status-${getStatusClass(job.current_step)}`;

            // Show/hide stop button
            document.getElementById('stop-btn').classList.toggle('hidden',
                ['completed', 'failed', 'pending'].includes(job.current_step));

            // Update progress steps
            renderProgressSteps(job.current_step);

            // Update stats
            if (job.statistics) {
                updateStats(job.statistics);
            }
        }

        function renderProgressSteps(currentStep) {
            const container = document.getElementById('progress-steps');
            const currentIndex = PIPELINE_STEPS.findIndex(s => s.key === currentStep);

            container.innerHTML = PIPELINE_STEPS.map((step, index) => {
                let status = 'pending';
                if (index < currentIndex) status = 'completed';
                else if (index === currentIndex) status = 'active';

                return `
                    <div class="progress-step ${status}">
                        <span class="step-icon">${status === 'completed' ? 'âœ“' : index + 1}</span>
                        <span>${step.label}</span>
                    </div>
                `;
            }).join('');
        }

        function updateProgressStep(stepKey, completed) {
            renderProgressSteps(completed ? getNextStep(stepKey) : stepKey);
        }

        function getNextStep(currentKey) {
            const index = PIPELINE_STEPS.findIndex(s => s.key === currentKey);
            return index < PIPELINE_STEPS.length - 1 ? PIPELINE_STEPS[index + 1].key : 'completed';
        }

        function updateStats(stats) {
            if (stats.pmids_discovered !== undefined || stats.total_unique !== undefined) {
                document.getElementById('stat-pmids').textContent =
                    stats.total_unique || stats.pmids_discovered || '-';
            }
            if (stats.pmids_filtered !== undefined || stats.passed_filters !== undefined) {
                document.getElementById('stat-filtered').textContent =
                    stats.passed_filters || stats.pmids_filtered || '-';
            }
            if (stats.papers_downloaded !== undefined || stats.downloaded !== undefined) {
                document.getElementById('stat-downloaded').textContent =
                    stats.downloaded || stats.papers_downloaded || '-';
            }
            if (stats.papers_extracted !== undefined) {
                document.getElementById('stat-extracted').textContent =
                    stats.papers_extracted || '-';
            }
            // Handle total variants from extraction or aggregation steps
            if (stats.total_variants !== undefined || stats.variants_aggregated !== undefined || stats.total_variants_found !== undefined) {
                document.getElementById('stat-variants').textContent =
                    stats.total_variants || stats.variants_aggregated || stats.total_variants_found || '-';
            }
        }

        function appendLog(message, isError = false) {
            const viewer = document.getElementById('log-viewer');
            const line = document.createElement('div');
            line.className = 'log-line';
            line.style.color = isError ? '#ef4444' : '#10b981';
            line.textContent = message;
            viewer.appendChild(line);
            viewer.scrollTop = viewer.scrollHeight;
        }

        function updateJobComplete(status) {
            const statusBadge = document.getElementById('active-job-status');
            statusBadge.textContent = status === 'completed' ? 'Completed' : 'Failed';
            statusBadge.className = `status-badge status-${status}`;
            document.getElementById('stop-btn').classList.add('hidden');

            if (status === 'completed') {
                viewResults(activeJobId);
            }
        }

        function displayResults(results) {
            const card = document.getElementById('results-card');
            const content = document.getElementById('results-content');

            card.classList.remove('hidden');

            let html = `
                <p><strong>Output Directory:</strong> ${results.output_path}</p>
                <p><strong>Database:</strong> ${results.files.database}</p>
            `;

            if (results.workflow_summary) {
                const stats = results.workflow_summary.statistics;
                html += `
                    <h4 style="margin: 1rem 0 0.5rem;">Summary</h4>
                    <ul>
                        <li>PMIDs Discovered: ${stats.pmids_discovered || 0}</li>
                        <li>Papers Downloaded: ${stats.papers_downloaded || 0}</li>
                        <li>Papers Extracted: ${stats.papers_extracted || 0}</li>
                        <li>Total Variants: ${stats.total_variants_found || 0}</li>
                    </ul>
                `;
            }

            content.innerHTML = html;
        }

        // Initial load
        loadJobs();

        // =====================================================================
        // Settings Management
        // =====================================================================

        async function loadSettings() {
            try {
                const data = await apiCall('GET', '/settings');

                // Populate form fields
                for (const [key, value] of Object.entries(data.settings)) {
                    const input = document.getElementById(`setting-${key}`);
                    if (input) {
                        if (input.type === 'checkbox') {
                            input.checked = value === 'true' || value === true;
                        } else {
                            input.value = value || '';
                        }
                    }
                }

                // Update env file path display
                document.getElementById('env-file-path').textContent = data.env_file_path;

                // Validate settings
                await validateSettings();

                // Also update the email fields in job forms if empty
                const ncbiEmail = data.settings.NCBI_EMAIL;
                const emailField = document.getElementById('email');
                if (ncbiEmail && (!emailField.value || emailField.value === 'your@email.com')) {
                    emailField.value = ncbiEmail;
                }
                // Also populate folder job email field
                const folderEmailField = document.getElementById('folder-email');
                if (folderEmailField && ncbiEmail && (!folderEmailField.value || folderEmailField.value === 'your@email.com')) {
                    folderEmailField.value = ncbiEmail;
                }

                // Update output dir default if set
                const defaultOutput = data.settings.DEFAULT_OUTPUT_DIR;
                const outputField = document.getElementById('output');
                if (defaultOutput && outputField.value === './output') {
                    outputField.value = defaultOutput;
                }

            } catch (err) {
                console.error('Failed to load settings:', err);
            }
        }

        async function saveSettings() {
            const form = document.getElementById('settings-form');
            const formData = new FormData(form);
            const settings = {};

            // Collect all settings
            for (const [key, config] of Object.entries(getSettingsKeys())) {
                const input = document.getElementById(`setting-${key}`);
                if (input) {
                    if (input.type === 'checkbox') {
                        settings[key] = input.checked ? 'true' : 'false';
                    } else {
                        settings[key] = input.value;
                    }
                }
            }

            try {
                await apiCall('POST', '/settings', { settings });

                // Show success message
                const validation = document.getElementById('settings-validation');
                validation.className = 'alert alert-success';
                validation.textContent = 'Settings saved successfully!';
                validation.classList.remove('hidden');

                // Re-validate
                await validateSettings();

                // Hide success after 3 seconds
                setTimeout(() => {
                    if (validation.classList.contains('alert-success')) {
                        validation.classList.add('hidden');
                    }
                }, 3000);

            } catch (err) {
                alert('Failed to save settings: ' + err.message);
            }
        }

        async function validateSettings() {
            try {
                const result = await apiCall('GET', '/settings/validate');
                const validation = document.getElementById('settings-validation');

                if (!result.valid) {
                    validation.className = 'alert alert-error';
                    validation.innerHTML = '<strong>Configuration Issues:</strong><ul>' +
                        result.issues.map(i => `<li>${i}</li>`).join('') +
                        '</ul>';
                    validation.classList.remove('hidden');
                } else if (result.warnings.length > 0) {
                    validation.className = 'alert alert-warning';
                    validation.innerHTML = '<strong>Warnings:</strong><ul>' +
                        result.warnings.map(w => `<li>${w}</li>`).join('') +
                        '</ul>';
                    validation.classList.remove('hidden');
                } else {
                    validation.classList.add('hidden');
                }
            } catch (err) {
                console.error('Failed to validate settings:', err);
            }
        }

        function getSettingsKeys() {
            // Return the settings we're managing
            return {
                'OPENAI_API_KEY': true,
                'ANTHROPIC_API_KEY': true,
                'NCBI_EMAIL': true,
                'NCBI_API_KEY': true,
                'TIER2_MODEL': true,
                'TIER3_MODELS': true,
                'ENABLE_TIER1': true,
                'ENABLE_TIER2': true,
                'TIER2_CONFIDENCE_THRESHOLD': true,
                'USE_PUBMIND': true,
                'USE_PUBMED': true,
                'USE_EUROPEPMC': true,
                'SCOUT_ENABLED': true,
                'SCOUT_MIN_RELEVANCE': true,
                'DEFAULT_OUTPUT_DIR': true,
            };
        }

        // =====================================================================
        // Directory Browser
        // =====================================================================

        let dirBrowserState = {
            targetInput: null,
            currentPath: '~',
            selectedPath: null,
            parentPath: null,
        };

        async function openDirectoryBrowser(inputId) {
            dirBrowserState.targetInput = inputId;
            const input = document.getElementById(inputId);
            const startPath = input.value || '~';

            document.getElementById('directory-modal').classList.remove('hidden');

            // Load shortcuts
            await loadDirectoryShortcuts();

            // Navigate to starting path
            await navigateToPath(startPath);
        }

        function closeDirectoryBrowser() {
            document.getElementById('directory-modal').classList.add('hidden');
            dirBrowserState.targetInput = null;
            dirBrowserState.selectedPath = null;
        }

        async function loadDirectoryShortcuts() {
            try {
                const data = await apiCall('GET', '/browse/shortcuts');
                const container = document.getElementById('dir-shortcuts');

                const iconMap = {
                    'home': 'ðŸ ',
                    'desktop': 'ðŸ–¥ï¸',
                    'folder': 'ðŸ“',
                    'code': 'ðŸ“‚',
                    'output': 'ðŸ“¤',
                };

                container.innerHTML = data.shortcuts.map(s => `
                    <div class="dir-shortcut" onclick="navigateToPath('${s.path}')">
                        <span>${iconMap[s.icon] || 'ðŸ“'}</span>
                        <span>${s.name}</span>
                    </div>
                `).join('');
            } catch (err) {
                console.error('Failed to load shortcuts:', err);
            }
        }

        async function navigateToPath(path) {
            const listing = document.getElementById('dir-listing');
            listing.innerHTML = '<p class="loading">Loading...</p>';

            try {
                const data = await apiCall('GET', `/browse?path=${encodeURIComponent(path)}`);

                dirBrowserState.currentPath = data.current_path;
                dirBrowserState.parentPath = data.parent_path;
                dirBrowserState.selectedPath = data.current_path;

                // Update path input
                document.getElementById('dir-current-path').value = data.current_path;

                // Update up button
                document.getElementById('dir-up-btn').disabled = !data.parent_path;

                // Render directory listing
                if (data.entries.length === 0) {
                    listing.innerHTML = '<p class="loading">Empty directory</p>';
                } else {
                    listing.innerHTML = data.entries
                        .filter(e => e.is_dir)  // Only show directories
                        .map(entry => `
                            <div class="dir-item ${!entry.is_readable ? 'disabled' : ''}"
                                 onclick="${entry.is_readable ? `navigateToPath('${entry.path.replace(/'/g, "\\'")}')` : ''}"
                                 title="${entry.path}">
                                <span class="dir-item-icon">ðŸ“</span>
                                <span class="dir-item-name">${entry.name}</span>
                            </div>
                        `).join('');

                    // If no directories, show message
                    if (data.entries.filter(e => e.is_dir).length === 0) {
                        listing.innerHTML = '<p class="loading">No subdirectories</p>';
                    }
                }

            } catch (err) {
                listing.innerHTML = `<p class="loading" style="color: var(--error);">Error: ${err.message}</p>`;
            }
        }

        function navigateUp() {
            if (dirBrowserState.parentPath) {
                navigateToPath(dirBrowserState.parentPath);
            }
        }

        async function createNewFolder() {
            const nameInput = document.getElementById('new-folder-name');
            const name = nameInput.value.trim();

            if (!name) {
                alert('Please enter a folder name');
                return;
            }

            const newPath = dirBrowserState.currentPath + '/' + name;

            try {
                await apiCall('POST', `/browse/create?path=${encodeURIComponent(newPath)}`);
                nameInput.value = '';
                await navigateToPath(dirBrowserState.currentPath);
                // Select the new folder
                await navigateToPath(newPath);
            } catch (err) {
                alert('Failed to create folder: ' + err.message);
            }
        }

        function selectDirectory() {
            if (dirBrowserState.targetInput && dirBrowserState.selectedPath) {
                document.getElementById(dirBrowserState.targetInput).value = dirBrowserState.selectedPath;
            }
            closeDirectoryBrowser();
        }

        // Also add browse button to the output directory field in new job form
        function addBrowseToJobForm() {
            const outputGroup = document.getElementById('output').parentElement;
            const input = document.getElementById('output');

            // Wrap input with button
            const wrapper = document.createElement('div');
            wrapper.className = 'input-with-button';

            input.parentNode.insertBefore(wrapper, input);
            wrapper.appendChild(input);

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-secondary';
            btn.textContent = 'Browse';
            btn.onclick = () => openDirectoryBrowser('output');
            wrapper.appendChild(btn);
        }

        // =====================================================================
        // Folder Job Mode
        // =====================================================================

        function setJobMode(mode) {
            currentJobMode = mode;

            // Update toggle buttons
            document.querySelectorAll('.job-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Show/hide panels
            document.getElementById('new-job-panel').classList.toggle('hidden', mode !== 'new');
            document.getElementById('folder-job-panel').classList.toggle('hidden', mode !== 'folder');

            // Reset folder analysis when switching to folder mode
            if (mode === 'folder') {
                document.getElementById('folder-analysis').classList.add('hidden');
                document.getElementById('folder-submit-btn').disabled = true;
                lastFolderAnalysis = null;
            }
        }

        async function analyzeFolder() {
            const pathInput = document.getElementById('folder-path');
            const path = pathInput.value.trim();

            if (!path) {
                alert('Please enter or select a folder path');
                return;
            }

            const analysisDiv = document.getElementById('folder-analysis');
            const contentDiv = document.getElementById('folder-analysis-content');
            const submitBtn = document.getElementById('folder-submit-btn');

            // Show loading state
            analysisDiv.classList.remove('hidden');
            contentDiv.innerHTML = '<p style="color: var(--gray-500);">Analyzing folder...</p>';
            submitBtn.disabled = true;

            try {
                const analysis = await apiCall('GET', `/analyze-folder?path=${encodeURIComponent(path)}`);
                lastFolderAnalysis = analysis;

                // Auto-fill gene symbol if detected
                if (analysis.gene_symbol) {
                    document.getElementById('folder-gene').value = analysis.gene_symbol;
                }

                // Render analysis results
                let statusClass = 'ready';
                let statusText = analysis.status_message;

                if (!analysis.is_valid) {
                    statusClass = 'error';
                    statusText = 'Invalid folder: ' + analysis.status_message;
                } else if (analysis.pipeline_breakdown?.likely_interrupted) {
                    statusClass = 'interrupted';
                } else if (!analysis.scouting_complete && analysis.full_context_count > analysis.data_zones_count) {
                    statusClass = 'needs-scout';
                }

                // Build pipeline breakdown HTML if available
                let pipelineBreakdownHtml = '';
                const pb = analysis.pipeline_breakdown;
                if (pb && pb.has_discovery_data) {
                    pipelineBreakdownHtml = `
                        <div class="pipeline-breakdown">
                            <div class="pipeline-breakdown-title">
                                <span class="icon">&#128202;</span> Pipeline Status Breakdown
                            </div>
                            <div class="pipeline-stages">
                                <div class="pipeline-stage">
                                    <span class="pipeline-stage-name">1. Discovery</span>
                                    <div class="pipeline-stage-counts">
                                        <div class="pipeline-stage-count success">
                                            <div class="value">${pb.discovered_count}</div>
                                            <div class="label">PMIDs found</div>
                                        </div>
                                    </div>
                                </div>
                                ${pb.has_harvest_data ? `
                                <div class="pipeline-stage">
                                    <span class="pipeline-stage-name">2. Harvesting</span>
                                    <div class="pipeline-stage-counts">
                                        <div class="pipeline-stage-count ${pb.harvested_count > 0 ? 'success' : 'neutral'}">
                                            <div class="value">${pb.harvested_count}</div>
                                            <div class="label">Harvested</div>
                                        </div>
                                        ${pb.harvest_gap_count > 0 ? `
                                        <div class="pipeline-stage-count error">
                                            <div class="value">${pb.harvest_gap_count}</div>
                                            <div class="label">Missing</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                ` : ''}
                                ${pb.has_filter_data || pb.filtered_out_count > 0 ? `
                                <div class="pipeline-stage">
                                    <span class="pipeline-stage-name">3. Filtering</span>
                                    <div class="pipeline-stage-counts">
                                        <div class="pipeline-stage-count warning">
                                            <div class="value">${pb.filtered_out_count}</div>
                                            <div class="label">Filtered out</div>
                                        </div>
                                    </div>
                                </div>
                                ` : ''}
                                ${pb.has_download_data || pb.downloaded_count > 0 || pb.paywalled_count > 0 ? `
                                <div class="pipeline-stage">
                                    <span class="pipeline-stage-name">4. Download</span>
                                    <div class="pipeline-stage-counts">
                                        <div class="pipeline-stage-count success">
                                            <div class="value">${pb.downloaded_count}</div>
                                            <div class="label">Downloaded</div>
                                        </div>
                                        ${pb.paywalled_count > 0 ? `
                                        <div class="pipeline-stage-count warning" style="cursor: pointer;" onclick="showBrowserFetchModal('${path}', '${analysis.gene_symbol || ''}', ${pb.paywalled_count})">
                                            <div class="value">${pb.paywalled_count}</div>
                                            <div class="label">Paywalled</div>
                                            <div class="label" style="font-size: 0.65rem; color: var(--primary);">Click to fetch</div>
                                        </div>
                                        ` : ''}
                                        ${pb.download_gap_count > 0 ? `
                                        <div class="pipeline-stage-count error">
                                            <div class="value">${pb.download_gap_count}</div>
                                            <div class="label">Missing</div>
                                        </div>
                                        ` : ''}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            ${pb.likely_interrupted ? `
                            <div class="pipeline-gap-alert">
                                <strong>Possible Interruption Detected at ${pb.interruption_stage} stage</strong>
                                ${pb.interruption_details || ''}
                                ${pb.harvest_gap_pmids?.length > 0 ? `
                                <div class="pipeline-collapsible" onclick="this.classList.toggle('open'); this.nextElementSibling.classList.toggle('open');">
                                    View ${pb.harvest_gap_pmids.length} missing PMIDs
                                </div>
                                <div class="pipeline-details">
                                    <div class="pipeline-pmid-list">${pb.harvest_gap_pmids.slice(0, 100).join(', ')}${pb.harvest_gap_pmids.length > 100 ? '...' : ''}</div>
                                </div>
                                ` : ''}
                                ${pb.download_gap_pmids?.length > 0 && pb.interruption_stage === 'downloading' ? `
                                <div class="pipeline-collapsible" onclick="this.classList.toggle('open'); this.nextElementSibling.classList.toggle('open');">
                                    View ${pb.download_gap_pmids.length} missing PMIDs
                                </div>
                                <div class="pipeline-details">
                                    <div class="pipeline-pmid-list">${pb.download_gap_pmids.slice(0, 100).join(', ')}${pb.download_gap_pmids.length > 100 ? '...' : ''}</div>
                                </div>
                                ` : ''}
                                <div class="resume-pipeline-section" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.1);">
                                    <p style="margin-bottom: 0.5rem; font-size: 0.875rem;">You can resume the pipeline to download the missing papers and continue extraction.</p>
                                    <button type="button" class="btn btn-success" onclick="resumePipeline('${pb.interruption_stage}')">
                                        Resume Pipeline
                                    </button>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    `;
                }

                contentDiv.innerHTML = `
                    <div class="analysis-status ${statusClass}">${statusText}</div>
                    <div class="analysis-stats">
                        <div class="analysis-stat">
                            <div class="analysis-stat-value">${analysis.full_context_count}</div>
                            <div class="analysis-stat-label">Full-Text Papers</div>
                        </div>
                        <div class="analysis-stat">
                            <div class="analysis-stat-value">${analysis.data_zones_count}</div>
                            <div class="analysis-stat-label">Scouted (DATA_ZONES)</div>
                        </div>
                        <div class="analysis-stat">
                            <div class="analysis-stat-value">${analysis.extraction_count}</div>
                            <div class="analysis-stat-label">Already Extracted</div>
                        </div>
                    </div>
                    ${pipelineBreakdownHtml}
                    ${(() => {
                        const unextractedCount = analysis.full_context_count - analysis.extraction_count;
                        if (unextractedCount > 0) {
                            return '<p style="margin-top: 0.75rem; color: var(--gray-600); font-size: 0.875rem;"><strong>' + unextractedCount + ' papers</strong> have not been extracted yet.</p>';
                        }
                        return '';
                    })()}
                    ${analysis.recommendations.length > 0 ? `
                        <ul class="analysis-recommendations">
                            ${analysis.recommendations.map(r => `<li>${r}</li>`).join('')}
                        </ul>
                    ` : ''}
                    ${analysis.pipeline_breakdown && analysis.pipeline_breakdown.paywalled_count > 0 ? `
                        <div id="paywalled-fetch-section" style="margin-top: 1rem; padding: 1rem; background: var(--warning-light, #fff3cd); border-radius: 0.5rem; border: 1px solid var(--warning, #ffc107);">
                            <strong>${analysis.pipeline_breakdown.paywalled_count} paywalled papers</strong> could not be downloaded automatically.
                            <button type="button" class="btn btn-warning" style="margin-left: 1rem;" onclick="showBrowserFetchModal('${path}', '${analysis.gene_symbol || ''}', ${analysis.pipeline_breakdown.paywalled_count})">
                                Fetch with Browser
                            </button>
                        </div>
                    ` : ''}
                `;

                // Check for paywalled_missing.csv even if pipeline_breakdown doesn't show it
                checkForPaywalledCsv(path, analysis.gene_symbol);

                // Enable submit button if valid
                submitBtn.disabled = !analysis.is_valid;

                // Auto-check "Run Scout" if papers are unscouted
                if (analysis.has_fulltext && !analysis.scouting_complete) {
                    document.getElementById('run-scout').checked = true;
                }

            } catch (err) {
                contentDiv.innerHTML = `<div class="analysis-status error">Error: ${err.message}</div>`;
                submitBtn.disabled = true;
            }
        }

        // Handle folder job form submission
        document.getElementById('folder-job-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!lastFolderAnalysis || !lastFolderAnalysis.is_valid) {
                alert('Please analyze a valid folder first');
                return;
            }

            const formData = new FormData(e.target);
            const data = {
                folder_path: formData.get('folder_path'),
                gene_symbol: formData.get('gene_symbol'),
                email: formData.get('email'),
                run_scout: document.getElementById('run-scout').checked,
                skip_already_extracted: document.getElementById('skip-extracted').checked,
                tier_threshold: parseInt(formData.get('tier_threshold')) || 1,
                scout_min_relevance: parseFloat(formData.get('scout_min_relevance')) || 0.3,
            };

            try {
                const job = await apiCall('POST', '/jobs/from-folder', data);
                activeJobId = job.job_id;
                showTab('active');
                connectWebSocket(job.job_id);
            } catch (err) {
                alert('Failed to create job: ' + err.message);
            }
        });

        // Resume Pipeline - handles resuming interrupted pipelines
        async function resumePipeline(resumeStage) {
            if (!lastFolderAnalysis) {
                alert('Please analyze a folder first');
                return;
            }

            const analysis = lastFolderAnalysis;
            const pb = analysis.pipeline_breakdown;

            // Get form values from the folder job form
            const geneSymbol = document.getElementById('folder-gene').value;
            const email = document.getElementById('folder-email').value;
            const folderPath = document.getElementById('folder-path').value;

            if (!geneSymbol) {
                alert('Please enter a gene symbol');
                document.getElementById('folder-gene').focus();
                return;
            }

            if (!email) {
                alert('Please enter an email address');
                document.getElementById('folder-email').focus();
                return;
            }

            // Determine which PMIDs need to be downloaded
            let pmidsToDownload = [];
            if (resumeStage === 'downloading' && pb.download_gap_pmids?.length > 0) {
                pmidsToDownload = pb.download_gap_pmids;
            } else if (resumeStage === 'harvesting' && pb.harvest_gap_pmids?.length > 0) {
                // For harvest gaps, we'd need to re-run harvesting first (not yet supported)
                alert('Resuming from harvesting stage is not yet supported. Please start a new pipeline.');
                return;
            }

            const data = {
                folder_path: folderPath,
                gene_symbol: geneSymbol,
                email: email,
                resume_stage: resumeStage === 'downloading' ? 'downloading' : 'extraction',
                pmids_to_download: pmidsToDownload,
                max_papers_to_download: Math.min(pmidsToDownload.length, 1000),
                run_scout: document.getElementById('run-scout').checked,
                skip_already_extracted: document.getElementById('skip-extracted').checked,
                tier_threshold: parseInt(document.getElementById('tier-threshold-folder')?.value) || 1,
                scout_min_relevance: parseFloat(document.getElementById('scout-min-relevance')?.value) || 0.3,
            };

            // Confirm with user
            const confirmMsg = resumeStage === 'downloading'
                ? `Resume downloading ${pmidsToDownload.length} missing papers and continue pipeline?`
                : `Resume extraction for papers that haven't been extracted yet?`;

            if (!confirm(confirmMsg)) {
                return;
            }

            try {
                const job = await apiCall('POST', '/jobs/resume-folder', data);
                activeJobId = job.job_id;
                showTab('active');
                connectWebSocket(job.job_id);
            } catch (err) {
                alert('Failed to resume pipeline: ' + err.message);
            }
        }

        // =====================================================================
        // Browser Fetch for Paywalled Papers
        // =====================================================================

        async function checkForPaywalledCsv(folderPath, geneSymbol) {
            // Check if paywalled_missing.csv exists and add button if it does
            const csvPath = folderPath + '/pmc_fulltext/paywalled_missing.csv';
            const parentCsvPath = folderPath + '/paywalled_missing.csv';

            try {
                // Try to check if the CSV exists by attempting to analyze the folder
                const response = await fetch(`/api/browse?path=${encodeURIComponent(folderPath + '/pmc_fulltext')}`);
                if (response.ok) {
                    const data = await response.json();
                    const hasPaywalledCsv = data.entries && data.entries.some(e => e.name === 'paywalled_missing.csv');

                    if (hasPaywalledCsv) {
                        // Count lines in CSV to get number of paywalled papers
                        const existingDiv = document.getElementById('paywalled-fetch-section');
                        if (!existingDiv) {
                            const contentDiv = document.getElementById('folder-analysis-content');
                            const fetchDiv = document.createElement('div');
                            fetchDiv.id = 'paywalled-fetch-section';
                            fetchDiv.style.cssText = 'margin-top: 1rem; padding: 1rem; background: #fff3cd; border-radius: 0.5rem; border: 1px solid #ffc107;';
                            fetchDiv.innerHTML = `
                                <strong>Paywalled papers found</strong> - Some papers could not be downloaded automatically.
                                <button type="button" class="btn" style="margin-left: 1rem; background: #ffc107; color: #000;" onclick="showBrowserFetchModal('${folderPath}', '${geneSymbol || ''}', 0)">
                                    Fetch with Browser
                                </button>
                            `;
                            contentDiv.appendChild(fetchDiv);
                        }
                    }
                }
            } catch (e) {
                // Ignore errors - just means we can't check for the CSV
                console.debug('Could not check for paywalled CSV:', e);
            }
        }

        let browserFetchTaskId = null;
        let browserFetchPollInterval = null;

        function showBrowserFetchModal(folderPath, geneSymbol, count) {
            const csvPath = folderPath + '/pmc_fulltext/paywalled_missing.csv';
            const countText = count > 0 ? `<strong>${count} paywalled papers</strong>` : '<strong>Paywalled papers</strong>';

            const modal = document.createElement('div');
            modal.id = 'browser-fetch-modal';
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px; max-height: 90vh; display: flex; flex-direction: column;">
                    <div class="modal-header">
                        <h3>Fetch Paywalled Papers</h3>
                        <button class="close-btn" onclick="closeBrowserFetchModal()">&times;</button>
                    </div>
                    <div class="modal-body" style="flex: 1; overflow: hidden; display: flex; flex-direction: column;">
                        <p style="margin-bottom: 1rem;">
                            ${countText} could not be downloaded automatically.
                            The browser fetcher will attempt to download them using browser automation.
                        </p>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="bf-headless" checked>
                                Run in headless mode (faster, no visible browser)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="bf-use-claude">
                                Use Claude to find download links (requires API key)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="bf-retry-failures">
                                Retry failed papers only (re-attempt browser_failed status)
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="bf-wait-captcha">
                                Wait for manual CAPTCHA (5 min timeout, uncheck headless to see browser)
                            </label>
                        </div>
                        <div id="bf-status" style="display: none; margin-top: 1rem; padding: 1rem; background: var(--gray-100); border-radius: 0.5rem; flex: 1; display: flex; flex-direction: column; overflow: hidden;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <div id="bf-status-text" style="font-weight: 600;">Starting...</div>
                                <div id="bf-progress-count" style="font-size: 0.85rem; color: var(--gray-600);"></div>
                            </div>
                            <div id="bf-current-step" style="font-size: 0.85rem; color: var(--primary); margin-bottom: 0.5rem;"></div>
                            <div id="bf-logs" style="flex: 1; min-height: 200px; max-height: 300px; overflow-y: auto; background: #1e1e1e; color: #d4d4d4; font-family: monospace; font-size: 0.75rem; padding: 0.5rem; border-radius: 0.25rem; white-space: pre-wrap; word-break: break-all;"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="closeBrowserFetchModal()">Cancel</button>
                        <button class="btn btn-primary" id="bf-start-btn" onclick="startBrowserFetch('${csvPath}', '${geneSymbol}')">
                            Start Fetch
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }

        function closeBrowserFetchModal() {
            const modal = document.getElementById('browser-fetch-modal');
            if (modal) {
                modal.remove();
            }
            if (browserFetchPollInterval) {
                clearInterval(browserFetchPollInterval);
                browserFetchPollInterval = null;
            }
        }

        async function startBrowserFetch(csvPath, geneSymbol) {
            const headless = document.getElementById('bf-headless').checked;
            const useClaude = document.getElementById('bf-use-claude').checked;
            const retryFailures = document.getElementById('bf-retry-failures').checked;
            const waitForCaptcha = document.getElementById('bf-wait-captcha').checked;
            const statusDiv = document.getElementById('bf-status');
            const statusText = document.getElementById('bf-status-text');
            const progressCount = document.getElementById('bf-progress-count');
            const currentStep = document.getElementById('bf-current-step');
            const logsDiv = document.getElementById('bf-logs');
            const startBtn = document.getElementById('bf-start-btn');

            statusDiv.style.display = 'flex';
            statusText.textContent = 'Starting browser fetch...';
            logsDiv.textContent = 'Initializing...\n';
            startBtn.disabled = true;
            startBtn.textContent = 'Running...';

            // Helper to update logs display
            function updateLogs(logs) {
                if (logs && logs.length > 0) {
                    // Color-code certain lines
                    const coloredLogs = logs.map(line => {
                        if (line.includes('SUCCESS')) return `<span style="color: #4ec9b0;">${escapeHtml(line)}</span>`;
                        if (line.includes('FAILED') || line.includes('ERROR')) return `<span style="color: #f14c4c;">${escapeHtml(line)}</span>`;
                        if (line.includes('>>>')) return `<span style="color: #569cd6;">${escapeHtml(line)}</span>`;
                        if (line.includes('Processing PMID') || line.includes('Fetching PMID')) return `<span style="color: #dcdcaa;">${escapeHtml(line)}</span>`;
                        if (line.includes('[') && line.includes(']')) return `<span style="color: #9cdcfe;">${escapeHtml(line)}</span>`;
                        return escapeHtml(line);
                    }).join('\n');
                    logsDiv.innerHTML = coloredLogs;
                    // Auto-scroll to bottom
                    logsDiv.scrollTop = logsDiv.scrollHeight;
                }
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            try {
                const response = await fetch('/api/browser-fetch/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        csv_path: csvPath,
                        gene_symbol: geneSymbol,
                        headless: headless,
                        use_claude: useClaude,
                        retry_failures_only: retryFailures,
                        wait_for_captcha: waitForCaptcha
                    })
                });

                if (!response.ok) {
                    throw new Error((await response.json()).detail || 'Failed to start');
                }

                const task = await response.json();
                browserFetchTaskId = task.task_id;

                // Poll for status (faster polling for better log updates)
                browserFetchPollInterval = setInterval(async () => {
                    try {
                        const statusResponse = await fetch(`/api/browser-fetch/status/${browserFetchTaskId}`);
                        const status = await statusResponse.json();

                        // Update progress count
                        if (status.total > 0) {
                            progressCount.textContent = `${status.progress}/${status.total} papers | âœ“${status.successful} âœ—${status.failed}`;
                        }

                        // Update current step
                        if (status.current_step) {
                            currentStep.textContent = status.current_step;
                        }

                        // Update logs
                        if (status.recent_logs && status.recent_logs.length > 0) {
                            updateLogs(status.recent_logs);
                        }

                        if (status.status === 'running') {
                            if (status.current_pmid) {
                                statusText.textContent = `Fetching PMID ${status.current_pmid}...`;
                            } else {
                                statusText.textContent = 'Fetching papers...';
                            }
                        } else if (status.status === 'completed') {
                            clearInterval(browserFetchPollInterval);
                            statusText.innerHTML = `<span style="color: var(--success);">Complete!</span>`;
                            progressCount.textContent = `Downloaded: ${status.successful}/${status.total} papers`;
                            currentStep.textContent = '';
                            startBtn.textContent = 'Done';
                            startBtn.onclick = closeBrowserFetchModal;
                            startBtn.disabled = false;
                        } else if (status.status === 'failed') {
                            clearInterval(browserFetchPollInterval);
                            statusText.innerHTML = `<span style="color: var(--error);">Failed</span>`;
                            currentStep.textContent = status.error || 'Unknown error';
                            startBtn.textContent = 'Close';
                            startBtn.onclick = closeBrowserFetchModal;
                            startBtn.disabled = false;
                        }
                    } catch (e) {
                        console.error('Error polling status:', e);
                    }
                }, 1000);  // Poll every second for responsive updates

            } catch (err) {
                statusText.innerHTML = `<span style="color: var(--error);">Error: ${err.message}</span>`;
                logsDiv.textContent = err.message;
                startBtn.textContent = 'Close';
                startBtn.onclick = closeBrowserFetchModal;
                startBtn.disabled = false;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            addBrowseToJobForm();
            loadSettings();
        });
    </script>
</body>
</html>
